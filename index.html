<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班级官网 - 合肥实验学校20级2班</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 全局样式 */
        :root {
            --primary: #003366; --secondary: #D4AF37; --light: #f8f9fa; --dark: #212529;
            --gray: #6c757d; --success: #28a745; --danger: #dc3545; --vip: #9b59b6;
            --shadow: 0 4px 12px rgba(0,0,0,0.1); --radius: 8px; --transition: all 0.3s ease;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f5f7fa; color: var(--dark); line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .section { padding: 60px 0; }
        .section:nth-child(even) { background: white; }
        
        /* 按钮和卡片 */
        .btn { display: inline-block; padding: 10px 24px; background: var(--primary); color: white; 
            border: none; border-radius: var(--radius); font-weight: 600; cursor: pointer; transition: var(--transition); }
        .btn:hover { background: #002244; transform: translateY(-2px); box-shadow: var(--shadow); }
        .btn-secondary { background: var(--secondary); color: var(--dark); }
        .btn-vip { background: var(--vip); color: white; }
        .card { background: white; border-radius: var(--radius); padding: 20px; box-shadow: var(--shadow); }
        
        /* 导航栏 */
        .navbar { position: fixed; top: 0; width: 100%; background: rgba(255,255,255,0.95); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 1000; padding: 12px 0; }
        .nav-container { display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; }
        .badge-img { height: 45px; width: auto; }
        .user-info { display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 6px 12px; border-radius: var(--radius); }
        .user-avatar { width: 36px; height: 36px; border-radius: 50%; background: var(--primary); 
            color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .vip-badge { display: inline-block; padding: 2px 8px; background: linear-gradient(45deg, var(--vip), #e74c3c); 
            color: white; border-radius: 12px; font-size: 0.7rem; font-weight: bold; margin-left: 5px; }
        
        /* 英雄区域 */
        .hero { padding: 150px 0 80px; background: linear-gradient(rgba(0,51,102,0.85), rgba(0,51,102,0.9)); 
            color: white; text-align: center; }
        
        /* 网格布局 */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 25px; margin-top: 30px; }
        
        /* 模态框 */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); z-index: 1002; display: flex; justify-content: center; 
            align-items: center; opacity: 0; visibility: hidden; transition: var(--transition); }
        .modal.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; width: 90%; max-width: 500px; border-radius: var(--radius); 
            padding: 30px; position: relative; transform: translateY(-20px); transition: var(--transition); }
        .modal.active .modal-content { transform: translateY(0); }
        
        /* 封禁界面 */
        .ban-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); 
            z-index: 2000; display: flex; justify-content: center; align-items: center; color: white; text-align: center; }
        .ban-box { background: rgba(255,255,255,0.1); padding: 30px; border-radius: var(--radius); 
            backdrop-filter: blur(10px); max-width: 500px; width: 90%; }
        .ban-box h1 { color: #ff6b6b; font-size: 2.5rem; margin-bottom: 20px; }
        
        /* 管理面板 */
        .admin-panel { background: white; border-radius: var(--radius); padding: 20px; margin-top: 20px; }
        .admin-section { margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid #eee; }
        
        /* 响应式 */
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .hero { padding: 120px 0 60px; }
        }
    </style>
</head>
<body>
    <!-- 封禁界面（默认隐藏） -->
    <div class="ban-screen" id="banScreen" style="display: none;">
        <div class="ban-box">
            <h1>⚠️ 警告 ⚠️</h1>
            <div id="banReason">您因为违反班级规定，被封禁</div>
            <div id="banTime" style="margin: 20px 0; font-size: 1.2rem;">剩余解封时间: <span id="timeLeft">建议相关人员</span></div>
            <p style="margin: 20px 0;">您可以填写反馈尝试提前解封</p>
            <textarea id="appealText" placeholder="请输入您的申诉理由..." style="width:100%; height:100px; padding:10px; border-radius:var(--radius); margin-bottom:20px;"></textarea>
            <button class="btn btn-secondary" id="submitAppeal">提交申诉</button>
            <p style="margin-top: 30px; color: rgba(255,255,255,0.7);">班级官网制作团队</p>
        </div>
    </div>
    
    <!-- 主界面 -->
    <nav class="navbar">
        <div class="container nav-container">
            <div class="logo">
                <img src="school-logo.png" alt="班徽" class="badge-img">
                <div>
                    <h2 style="color: var(--primary);">20（2）班</h2>
                    <p style="font-size: 0.8rem; color: var(--gray);">数字家园</p>
                </div>
            </div>
            <div class="user-info" id="userInfo">
                <div class="user-avatar" id="userAvatar">访</div>
                <span id="userStatus">请登录</span>
                <span id="vipBadge" class="vip-badge" style="display: none;">VIP</span>
            </div>
        </div>
    </nav>
    
    <section class="hero" id="home">
        <div class="container">
            <h1 style="font-size: 2.5rem; margin-bottom: 20px;">欢迎来到20（2）班级数字家园</h1>
            <p style="font-size: 1.1rem; max-width: 800px; margin: 0 auto 30px;">这里是我们的班级官网，汇集班级动态、学习资源和交流平台</p>
            <button class="btn btn-secondary" id="exploreBtn">开始探索</button>
        </div>
    </section>
    
    <main class="container">
        <!-- 班级公告 -->
        <section class="section" id="announcements">
            <h2 style="font-size: 1.8rem; color: var(--primary); margin-bottom: 20px; text-align: center;">班级公告</h2>
            <div id="announcementsList"></div>
        </section>
        
        <!-- 积分商城 -->
        <section class="section" id="shop">
            <h2 style="font-size: 1.8rem; color: var(--primary); margin-bottom: 20px; text-align: center;">积分商城</h2>
            <p style="text-align: center; margin-bottom: 20px;">您的班币: <span id="coinCount" style="font-weight: bold; color: var(--secondary);">0</span></p>
            <div class="grid" id="shopItems"></div>
        </section>
        
        <!-- 举报系统 -->
        <section class="section" id="report">
            <h2 style="font-size: 1.8rem; color: var(--primary); margin-bottom: 20px; text-align: center;">举报系统</h2>
            <div class="card">
                <h3>提交举报</h3>
                <p>如果您发现违规行为，请在此举报</p>
                <div style="margin-top: 20px;">
                    <select id="reportType" class="form-control" style="margin-bottom: 15px;">
                        <option value="cheat">作弊行为</option>
                        <option value="content">不当内容</option>
                        <option value="harassment">骚扰行为</option>
                        <option value="other">其他</option>
                    </select>
                    <textarea id="reportDetails" placeholder="请详细描述举报内容..." 
                        style="width:100%; height:100px; padding:10px; border:1px solid #ddd; border-radius:var(--radius); margin-bottom:15px;"></textarea>
                    <button class="btn" id="submitReport">提交举报</button>
                </div>
            </div>
        </section>
        
        <!-- 管理面板（仅管理员可见） -->
        <section class="section" id="adminPanel" style="display: none;">
            <h2 style="font-size: 1.8rem; color: var(--primary); margin-bottom: 20px; text-align: center;">管理面板</h2>
            <div class="admin-panel">
                <div class="admin-section">
                    <h3>用户管理</h3>
                    <div id="userList"></div>
                </div>
                <div class="admin-section">
                    <h3>举报管理</h3>
                    <div id="reportList"></div>
                </div>
                <div class="admin-section">
                    <h3>VIP管理</h3>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="vipUsername" placeholder="用户名" class="form-control" style="margin-bottom: 10px;">
                        <button class="btn btn-vip" id="setVip">设为VIP</button>
                        <button class="btn" id="removeVip" style="margin-left: 10px;">取消VIP</button>
                    </div>
                    <div>
                        <h4>生成VIP兑换码</h4>
                        <button class="btn btn-secondary" id="generateCode">生成7天VIP码</button>
                        <div id="vipCodes" style="margin-top: 15px;"></div>
                    </div>
                </div>
                <div class="admin-section">
                    <h3>封禁管理</h3>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="banUsername" placeholder="用户名" class="form-control" style="margin-bottom: 10px;">
                        <input type="number" id="banDays" placeholder="封禁天数" class="form-control" style="margin-bottom: 10px;">
                        <textarea id="banReasonInput" placeholder="封禁原因" class="form-control" style="margin-bottom: 10px; height: 80px;"></textarea>
                        <button class="btn" id="banUser">封禁用户</button>
                        <button class="btn btn-secondary" id="unbanUser" style="margin-left: 10px;">解封用户</button>
                    </div>
                    <div id="bannedUsers"></div>
                </div>
            </div>
        </section>
    </main>
    
    <!-- 登录/注册模态框 -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div style="position: absolute; top: 15px; right: 15px; font-size: 1.5rem; cursor: pointer;" id="closeLoginModal">&times;</div>
            <h2 style="font-size: 1.8rem; color: var(--primary); margin-bottom: 25px; text-align: center;" id="modalTitle">用户登录</h2>
            
            <form id="loginForm">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">用户名</label>
                    <input type="text" id="loginUsername" class="form-control" required>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">密码</label>
                    <input type="password" id="loginPassword" class="form-control" required>
                </div>
                <div style="display: flex; align-items: center; margin-bottom: 20px;">
                    <input type="checkbox" id="rememberMe" style="margin-right: 10px;">
                    <label for="rememberMe">记住我</label>
                </div>
                <button type="submit" class="btn btn-secondary" style="width: 100%;">登录</button>
            </form>
            
            <form id="registerForm" style="display: none;">
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">用户名</label>
                    <input type="text" id="registerUsername" class="form-control" required>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">密码</label>
                    <input type="password" id="registerPassword" class="form-control" required>
                </div>
                <div style="margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600;">确认密码</label>
                    <input type="password" id="confirmPassword" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-secondary" style="width: 100%;">注册</button>
            </form>
            
            <div style="margin-top: 25px; text-align: center;">
                <p id="formToggleText">还没有账号？ <span style="color: var(--primary); font-weight: 600; cursor: pointer;" id="toggleForm">立即注册</span></p>
            </div>
            
            <!-- VIP兑换码输入 -->
            <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
                <h4 style="margin-bottom: 15px;">VIP兑换</h4>
                <input type="text" id="vipCodeInput" placeholder="输入VIP兑换码" class="form-control" style="margin-bottom: 10px;">
                <button class="btn btn-vip" id="redeemCode" style="width: 100%;">兑换VIP</button>
            </div>
        </div>
    </div>
    
    <footer style="background: var(--primary); color: white; padding: 50px 0 20px; text-align: center;">
        <div class="container">
            <p>&copy; 2026 202班最牛的程序猿 版权所有 | 班级官网制作团队</p>
        </div>
    </footer>
    
<script>
// ========== 预设账号区域（开发者在此设置） ==========
const PRESET_ACCOUNTS = {
    // 格式：用户名: {密码: "密码", role: "角色", coins: 班币数量}
    "管理员": {password: "syya", role: "管理员", coins: 9999999999999999999999999999999},
    "姚笑笑": {password: "teacherY", role: "班主任", coins: 99999999999999999999999999999},
    "VIP": {password: "VIP VIP VIP", role: "vip", coins: 200},
    "学生": {password: "student", role: "学生", coins: 0}
};
// ===============================================

// ========== 全局变量 ==========
let currentUser = null;
let isLoginForm = true;

// ========== DOM元素获取 ==========
const banScreen = document.getElementById('banScreen');
const userInfo = document.getElementById('userInfo');
const userAvatar = document.getElementById('userAvatar');
const userStatus = document.getElementById('userStatus');
const vipBadge = document.getElementById('vipBadge');
const loginModal = document.getElementById('loginModal');
const adminPanel = document.getElementById('adminPanel');

// ========== 初始化函数 ==========
function init() {
    // 检查是否被封禁
    checkBanStatus();
    
    // 检查本地存储中是否有用户信息
    const savedUser = localStorage.getItem('classUser');
    if (savedUser) {
        const user = JSON.parse(savedUser);
        if (!user.banned || user.banEnd && new Date() > new Date(user.banEnd)) {
            currentUser = user;
            updateUserUI();
            loadPageContent();
        }
    }
    
    // 设置事件监听器
    setupEventListeners();
    
    // 加载页面内容
    if (!currentUser) {
        loadPublicContent();
    }
}

// ========== 检查封禁状态 ==========
function checkBanStatus() {
    const savedUser = localStorage.getItem('classUser');
    if (savedUser) {
        const user = JSON.parse(savedUser);
        if (user.banned && user.banEnd && new Date() < new Date(user.banEnd)) {
            showBanScreen(user);
            return true;
        } else if (user.banned) {
            // 封禁已过期，解除封禁
            user.banned = false;
            delete user.banEnd;
            delete user.banReason;
            localStorage.setItem('classUser', JSON.stringify(user));
        }
    }
    return false;
}

// ========== 显示封禁界面 ==========
function showBanScreen(user) {
    banScreen.style.display = 'flex';
    document.getElementById('banReason').textContent = `您因为${user.banReason || "违反班级规定"}，被封禁${user.banDays || 7}天`;
    
    // 计算剩余时间
    const endTime = new Date(user.banEnd);
    updateBanTimeLeft(endTime);
    
    // 每秒更新剩余时间
    const timer = setInterval(() => {
        if (!updateBanTimeLeft(endTime)) {
            clearInterval(timer);
            location.reload();
        }
    }, 1000);
    
    // 申诉提交
    document.getElementById('submitAppeal').addEventListener('click', () => {
        const appealText = document.getElementById('appealText').value;
        if (appealText.trim()) {
            saveAppeal(user.username, appealText);
            alert('申诉已提交，管理员会尽快处理');
        } else {
            alert('请输入申诉理由');
        }
    });
}

// ========== 更新封禁剩余时间 ==========
function updateBanTimeLeft(endTime) {
    const now = new Date();
    const diff = endTime - now;
    
    if (diff <= 0) {
        document.getElementById('timeLeft').textContent = '已解封';
        return false;
    }
    
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));
    const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
    
    document.getElementById('timeLeft').textContent = `${days}天${hours}小时${minutes}分钟`;
    return true;
}

// ========== 保存申诉 ==========
function saveAppeal(username, appeal) {
    const appeals = JSON.parse(localStorage.getItem('banAppeals') || '[]');
    appeals.push({
        username,
        appeal,
        date: new Date().toISOString(),
        status: 'pending'
    });
    localStorage.setItem('banAppeals', JSON.stringify(appeals));
}

// ========== 设置事件监听器 ==========
function setupEventListeners() {
    // 用户信息点击
    userInfo.addEventListener('click', () => {
        if (!currentUser) {
            showLoginModal();
        } else {
            if (confirm('确定要退出登录吗？')) {
                logout();
            }
        }
    });
    
    // 探索按钮
    document.getElementById('exploreBtn').addEventListener('click', () => {
        if (!currentUser) {
            showLoginModal();
        } else {
            document.querySelector('#announcements').scrollIntoView({ behavior: 'smooth' });
        }
    });
    
    // 登录模态框
    document.getElementById('closeLoginModal').addEventListener('click', () => {
        loginModal.classList.remove('active');
    });
    
    // 表单切换
    document.getElementById('toggleForm').addEventListener('click', toggleLoginRegister);
    
    // 表单提交
    document.getElementById('loginForm').addEventListener('submit', handleLogin);
    document.getElementById('registerForm').addEventListener('submit', handleRegister);
    
    // VIP兑换
    document.getElementById('redeemCode').addEventListener('click', redeemVipCode);
    
    // 举报提交
    document.getElementById('submitReport').addEventListener('click', submitReport);
}

// ========== 用户系统 ==========
function showLoginModal() {
    loginModal.classList.add('active');
    resetForms();
}

function toggleLoginRegister() {
    isLoginForm = !isLoginForm;
    
    if (isLoginForm) {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('modalTitle').textContent = '用户登录';
        document.getElementById('formToggleText').innerHTML = '还没有账号？ <span style="color: var(--primary); font-weight: 600; cursor: pointer;" id="toggleForm">立即注册</span>';
    } else {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
        document.getElementById('modalTitle').textContent = '用户注册';
        document.getElementById('formToggleText').innerHTML = '已有账号？ <span style="color: var(--primary); font-weight: 600; cursor: pointer;" id="toggleForm">立即登录</span>';
    }
    
    // 重新绑定事件监听器
    document.getElementById('toggleForm').addEventListener('click', toggleLoginRegister);
}

function resetForms() {
    document.getElementById('loginForm').reset();
    document.getElementById('registerForm').reset();
    isLoginForm = true;
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('registerForm').style.display = 'none';
    document.getElementById('modalTitle').textContent = '用户登录';
    document.getElementById('formToggleText').innerHTML = '还没有账号？ <span style="color: var(--primary); font-weight: 600; cursor: pointer;" id="toggleForm">立即注册</span>';
}

function handleLogin(e) {
    e.preventDefault();
    
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    const rememberMe = document.getElementById('rememberMe').checked;
    
    if (!username || !password) {
        alert('请输入用户名和密码');
        return;
    }
    
    // 检查预设账号
    if (PRESET_ACCOUNTS[username] && PRESET_ACCOUNTS[username].password === password) {
        loginSuccess(username, PRESET_ACCOUNTS[username], rememberMe);
        return;
    }
    
    // 检查本地存储的用户
    const users = JSON.parse(localStorage.getItem('classUsers') || '[]');
    const user = users.find(u => u.username === username && u.password === password);
    
    if (user) {
        loginSuccess(username, user, rememberMe);
    } else {
        alert('用户名或密码错误');
    }
}

function loginSuccess(username, userData, rememberMe) {
    // 检查是否被封禁
    if (userData.banned && userData.banEnd && new Date() < new Date(userData.banEnd)) {
        currentUser = userData;
        showBanScreen(userData);
        return;
    }
    
    // 创建用户对象
    currentUser = {
        username: username,
        role: userData.role || 'member',
        coins: userData.coins || 0,
        avatarText: username.charAt(0).toUpperCase(),
        lastLogin: new Date().toISOString(),
        loginIP: getFakeIP() // 模拟IP，用于反作弊
    };
    
    // 保存到本地存储
    if (rememberMe) {
        localStorage.setItem('classUser', JSON.stringify(currentUser));
    } else {
        sessionStorage.setItem('classUser', JSON.stringify(currentUser));
    }
    
    // 更新用户列表中的信息
    updateUserInList(currentUser);
    
    updateUserUI();
    loginModal.classList.remove('active');
    showMessage('登录成功！', 'success');
    loadPageContent();
}

function handleRegister(e) {
    e.preventDefault();
    
    const username = document.getElementById('registerUsername').value;
    const password = document.getElementById('registerPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    // 验证
    if (!username || !password || !confirmPassword) {
        alert('请填写所有字段');
        return;
    }
    
    if (password !== confirmPassword) {
        alert('两次输入的密码不一致');
        return;
    }
    
    if (password.length < 6) {
        alert('密码长度至少为6位');
        return;
    }
    
    // 检查用户名是否已存在（包括预设账号）
    if (PRESET_ACCOUNTS[username]) {
        alert('用户名已存在');
        return;
    }
    
    const users = JSON.parse(localStorage.getItem('classUsers') || '[]');
    if (users.find(u => u.username === username)) {
        alert('用户名已存在');
        return;
    }
    
    // 创建新用户
    const newUser = {
        username,
        password,
        role: 'member',
        coins: 10, // 注册赠送10班币
        joinDate: new Date().toISOString(),
        loginIP: getFakeIP()
    };
    
    users.push(newUser);
    localStorage.setItem('classUsers', JSON.stringify(users));
    
    // 自动登录
    loginSuccess(username, newUser, true);
}

function logout() {
    currentUser = null;
    localStorage.removeItem('classUser');
    sessionStorage.removeItem('classUser');
    updateUserUI();
    showMessage('已退出登录', 'info');
    loadPublicContent();
}

function updateUserUI() {
    if (currentUser) {
        userAvatar.textContent = currentUser.avatarText;
        userStatus.textContent = currentUser.username;
        
        // 显示VIP徽章
        if (currentUser.role === 'vip' || currentUser.role === 'admin' || currentUser.role === 'teacher') {
            vipBadge.style.display = 'inline-block';
            userAvatar.style.background = 'var(--vip)';
        } else {
            vipBadge.style.display = 'none';
            userAvatar.style.background = 'var(--primary)';
        }
        
        // 显示管理员面板
        if (currentUser.role === 'admin' || currentUser.role === 'teacher') {
            adminPanel.style.display = 'block';
            loadAdminPanel();
        } else {
            adminPanel.style.display = 'none';
        }
    } else {
        userAvatar.textContent = '访';
        userStatus.textContent = '请登录';
        vipBadge.style.display = 'none';
        userAvatar.style.background = 'var(--primary)';
        adminPanel.style.display = 'none';
    }
}

// ========== 加载页面内容 ==========
function loadPublicContent() {
    generateAnnouncements();
    generateShopItems();
}

function loadPageContent() {
    loadPublicContent();
    document.getElementById('coinCount').textContent = currentUser.coins || 0;
}

// ========== 生成公告 ==========
function generateAnnouncements() {
    const announcements = [
        { title: '期末考试通知', content: '本学期期末考试将于1月28日开始，请提前复习。', date: '2026-1-20' },
        { title: '班级活动征集', content: '征集班级官网活动建议，欢迎大家踊跃提出。', date: '2026-1-20' },
        { title: '积分商城上线', content: '班币商城正式上线，可使用班币兑换各种权益。', date: '2026-1-21' }
    ];
    
    const container = document.getElementById('announcementsList');
    container.innerHTML = '';
    
    announcements.forEach(ann => {
        const item = document.createElement('div');
        item.className = 'card';
        item.style.marginBottom = '15px';
        item.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <div style="font-weight: 600; color: var(--primary);">${ann.title}</div>
                <div style="color: var(--gray); font-size: 0.9rem;">${ann.date}</div>
            </div>
            <div>${ann.content}</div>
        `;
        container.appendChild(item);
    });
}

// ========== 积分商城 ==========
function generateShopItems() {
    const shopItems = [
        { id: 1, name: '自定义头像框', price: 50, description: '获得专属头像框' },
        { id: 2, name: '特殊称号', price: 100, description: '获得"学霸"称号' },
        { id: 3, name: '优先发言权', price: 30, description: '在班级讨论中优先展示' },
        { id: 4, name: '7天VIP体验', price: 200, description: '体验VIP权益7天' }
    ];
    
    const container = document.getElementById('shopItems');
    container.innerHTML = '';
    
    shopItems.forEach(item => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <h4 style="color: var(--primary); margin-bottom: 10px;">${item.name}</h4>
            <p style="color: var(--gray); margin-bottom: 15px;">${item.description}</p>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="font-weight: bold; color: var(--secondary);">${item.price} 班币</span>
                <button class="btn btn-secondary" onclick="buyItem(${item.id})">兑换</button>
            </div>
        `;
        container.appendChild(card);
    });
}

function buyItem(itemId) {
    if (!currentUser) {
        showLoginModal();
        return;
    }
    
    const shopItems = [
        { id: 1, name: '自定义头像框', price: 50 },
        { id: 2, name: '特殊称号', price: 100 },
        { id: 3, name: '优先发言权', price: 30 },
        { id: 4, name: '7天VIP体验', price: 200 }
    ];
    
    const item = shopItems.find(i => i.id === itemId);
    if (!item) return;
    
    if (currentUser.coins < item.price) {
        alert('班币不足！');
        return;
    }
    
    if (confirm(`确定要兑换"${item.name}"吗？将消耗${item.price}班币`)) {
        currentUser.coins -= item.price;
        updateUserCoins();
        
        // 如果是VIP体验，设置VIP
        if (item.id === 4) {
            currentUser.role = 'vip';
            currentUser.vipExpire = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();
            updateUserUI();
        }
        
        showMessage(`成功兑换${item.name}！`, 'success');
        document.getElementById('coinCount').textContent = currentUser.coins;
    }
}

function updateUserCoins() {
    // 更新当前用户
    if (localStorage.getItem('classUser')) {
        localStorage.setItem('classUser', JSON.stringify(currentUser));
    }
    if (sessionStorage.getItem('classUser')) {
        sessionStorage.setItem('classUser', JSON.stringify(currentUser));
    }
    
    // 更新用户列表
    updateUserInList(currentUser);
}

// ========== 举报系统 ==========
function submitReport() {
    if (!currentUser) {
        showLoginModal();
        return;
    }
    
    const type = document.getElementById('reportType').value;
    const details = document.getElementById('reportDetails').value.trim();
    
    if (!details) {
        alert('请输入举报详情');
        return;
    }
    
    const reports = JSON.parse(localStorage.getItem('reports') || '[]');
    reports.push({
        id: Date.now(),
        reporter: currentUser.username,
        type,
        details,
        date: new Date().toISOString(),
        status: 'pending'
    });
    
    localStorage.setItem('reports', JSON.stringify(reports));
    document.getElementById('reportDetails').value = '';
    showMessage('举报已提交，管理员会尽快处理', 'success');
}

// ========== VIP兑换码系统 ==========
function redeemVipCode() {
    if (!currentUser) {
        showLoginModal();
        return;
    }
    
    const code = document.getElementById('vipCodeInput').value.trim();
    if (!code) {
        alert('请输入兑换码');
        return;
    }
    
    const vipCodes = JSON.parse(localStorage.getItem('vipCodes') || '[]');
    const validCode = vipCodes.find(c => c.code === code && !c.used);
    
    if (!validCode) {
        alert('兑换码无效或已使用');
        return;
    }
    
    // 使用兑换码
    validCode.used = true;
    validCode.usedBy = currentUser.username;
    validCode.usedDate = new Date().toISOString();
    localStorage.setItem('vipCodes', JSON.stringify(vipCodes));
    
    // 设置用户为VIP
    currentUser.role = 'vip';
    currentUser.vipExpire = new Date(Date.now() + validCode.days * 24 * 60 * 60 * 1000).toISOString();
    updateUserUI();
    updateUserInList(currentUser);
    
    document.getElementById('vipCodeInput').value = '';
    showMessage(`VIP兑换成功！有效期${validCode.days}天`, 'success');
}

// ========== 管理面板功能 ==========
function loadAdminPanel() {
    loadUserList();
    loadReportList();
    loadBannedUsers();
    loadVipCodes();
    
    // 设置VIP按钮
    document.getElementById('setVip').addEventListener('click', () => {
        const username = document.getElementById('vipUsername').value.trim();
        if (!username) return;
        
        if (confirm(`确定要将${username}设为VIP吗？`)) {
            setUserRole(username, 'vip');
        }
    });
    
    // 取消VIP按钮
    document.getElementById('removeVip').addEventListener('click', () => {
        const username = document.getElementById('vipUsername').value.trim();
        if (!username) return;
        
        if (confirm(`确定要取消${username}的VIP吗？`)) {
            setUserRole(username, 'member');
        }
    });
    
    // 生成VIP码按钮
    document.getElementById('generateCode').addEventListener('click', generateVipCode);
    
    // 封禁用户按钮
    document.getElementById('banUser').addEventListener('click', banUser);
    
    // 解封用户按钮
    document.getElementById('unbanUser').addEventListener('click', unbanUser);
}

function loadUserList() {
    // 获取所有用户（预设+本地）
    const presetUsers = Object.keys(PRESET_ACCOUNTS).map(name => ({
        username: name,
        role: PRESET_ACCOUNTS[name].role,
        coins: PRESET_ACCOUNTS[name].coins
    }));
    
    const localUsers = JSON.parse(localStorage.getItem('classUsers') || '[]');
    const allUsers = [...presetUsers, ...localUsers];
    
    const container = document.getElementById('userList');
    container.innerHTML = '';
    
    allUsers.forEach(user => {
        const div = document.createElement('div');
        div.style.padding = '10px';
        div.style.borderBottom = '1px solid #eee';
        div.innerHTML = `
            <strong>${user.username}</strong> - ${user.role} - ${user.coins || 0}班币
            <button onclick="editUser('${user.username}')" style="margin-left: 10px;">编辑</button>
        `;
        container.appendChild(div);
    });
}

function loadReportList() {
    const reports = JSON.parse(localStorage.getItem('reports') || '[]');
    const container = document.getElementById('reportList');
    container.innerHTML = '';
    
    if (reports.length === 0) {
        container.innerHTML = '<p>暂无举报</p>';
        return;
    }
    
    reports.forEach(report => {
        const div = document.createElement('div');
        div.style.padding = '10px';
        div.style.marginBottom = '10px';
        div.style.border = '1px solid #eee';
        div.style.borderRadius = 'var(--radius)';
        div.innerHTML = `
            <p><strong>举报人:</strong> ${report.reporter}</p>
            <p><strong>类型:</strong> ${report.type}</p>
            <p><strong>详情:</strong> ${report.details}</p>
            <p><strong>状态:</strong> ${report.status}</p>
            <button onclick="handleReport(${report.id}, 'resolved')" style="margin-right: 10px;">已处理</button>
            <button onclick="handleReport(${report.id}, 'rejected')">拒绝</button>
        `;
        container.appendChild(div);
    });
}

function loadBannedUsers() {
    const users = JSON.parse(localStorage.getItem('classUsers') || '[]');
    const bannedUsers = users.filter(u => u.banned);
    
    const container = document.getElementById('bannedUsers');
    container.innerHTML = '';
    
    if (bannedUsers.length === 0) {
        container.innerHTML = '<p>暂无封禁用户</p>';
        return;
    }
    
    bannedUsers.forEach(user => {
        const div = document.createElement('div');
        div.style.padding = '10px';
        div.style.marginBottom = '10px';
        div.style.border = '1px solid #ff6b6b';
        div.style.borderRadius = 'var(--radius)';
        div.innerHTML = `
            <p><strong>${user.username}</strong> - 封禁至: ${new Date(user.banEnd).toLocaleDateString()}</p>
            <p>原因: ${user.banReason}</p>
        `;
        container.appendChild(div);
    });
}

function loadVipCodes() {
    const vipCodes = JSON.parse(localStorage.getItem('vipCodes') || '[]');
    const container = document.getElementById('vipCodes');
    container.innerHTML = '';
    
    vipCodes.forEach(code => {
        const div = document.createElement('div');
        div.style.padding = '5px';
        div.style.marginBottom = '5px';
        div.style.background = code.used ? '#eee' : '#e8f5e9';
        div.innerHTML = `
            ${code.code} - ${code.days}天 - ${code.used ? '已使用' : '未使用'}
            ${code.used ? `(使用人: ${code.usedBy})` : ''}
        `;
        container.appendChild(div);
    });
}

function setUserRole(username, role) {
    // 更新预设账号
    if (PRESET_ACCOUNTS[username]) {
        PRESET_ACCOUNTS[username].role = role;
        // 注意：预设账号在内存中，刷新页面会重置
        alert('预设账号角色已更改（刷新页面会重置）');
    }
    
    // 更新本地用户
    const users = JSON.parse(localStorage.getItem('classUsers') || '[]');
    const userIndex = users.findIndex(u => u.username === username);
    if (userIndex !== -1) {
        users[userIndex].role = role;
        localStorage.setItem('classUsers', JSON.stringify(users));
    }
    
    // 如果当前用户是自己，更新UI
    if (currentUser && currentUser.username === username) {
        currentUser.role = role;
        updateUserUI();
    }
    
    loadUserList();
    showMessage(`已设置${username}为${role}`, 'success');
}

function generateVipCode() {
    const code = 'VIP' + Date.now().toString(36).toUpperCase();
    const days = 7;
    
    const vipCodes = JSON.parse(localStorage.getItem('vipCodes') || '[]');
    vipCodes.push({
        code,
        days,
        created: new Date().toISOString(),
        used: false
    });
    
    localStorage.setItem('vipCodes', JSON.stringify(vipCodes));
    loadVipCodes();
    showMessage(`已生成VIP兑换码: ${code}`, 'success');
}

function banUser() {
    const username = document.getElementById('banUsername').value.trim();
    const days = parseInt(document.getElementById('banDays').value);
    const reason = document.getElementById('banReasonInput').value.trim();
    
    if (!username || !days || !reason) {
        alert('请填写完整信息');
        return;
    }
    
    // 更新用户列表
    const users = JSON.parse(localStorage.getItem('classUsers') || '[]');
    const userIndex = users.findIndex(u => u.username === username);
    
    if (userIndex === -1 && !PRESET_ACCOUNTS[username]) {
        alert('用户不存在');
        return;
    }
    
    if (userIndex !== -1) {
        users[userIndex].banned = true;
        users[userIndex].banDays = days;
        users[userIndex].banReason = reason;
        users[userIndex].banEnd = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toISOString();
        localStorage.setItem('classUsers', JSON.stringify(users));
    }
    
    // 如果是当前用户，立即生效
    if (currentUser && currentUser.username === username) {
        currentUser.banned = true;
        currentUser.banDays = days;
        currentUser.banReason = reason;
        currentUser.banEnd = new Date(Date.now() + days * 24 * 60 * 60 * 1000).toISOString();
        localStorage.setItem('classUser', JSON.stringify(currentUser));
        showBanScreen(currentUser);
    }
    
    loadBannedUsers();
    showMessage(`已封禁用户${username}`, 'success');
}

function unbanUser() {
    const username = document.getElementById('banUsername').value.trim();
    if (!username) return;
    
    const users = JSON.parse(localStorage.getItem('classUsers') || '[]');
    const userIndex = users.findIndex(u => u.username === username);
    
    if (userIndex !== -1) {
        users[userIndex].banned = false;
        delete users[userIndex].banDays;
        delete users[userIndex].banReason;
        delete users[userIndex].banEnd;
        localStorage.setItem('classUsers', JSON.stringify(users));
    }
    
    loadBannedUsers();
    showMessage(`已解封用户${username}`, 'success');
}

// ========== 工具函数 ==========
function updateUserInList(user) {
    const users = JSON.parse(localStorage.getItem('classUsers') || '[]');
    const userIndex = users.findIndex(u => u.username === user.username);
    
    if (userIndex !== -1) {
        users[userIndex] = { ...users[userIndex], ...user };
        localStorage.setItem('classUsers', JSON.stringify(users));
    }
}

function getFakeIP() {
    // 生成模拟IP地址，用于反作弊记录
    return `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
}

function showMessage(message, type) {
    const msg = document.createElement('div');
    msg.textContent = message;
    msg.style.position = 'fixed';
    msg.style.top = '20px';
    msg.style.right = '20px';
    msg.style.padding = '15px 25px';
    msg.style.borderRadius = 'var(--radius)';
    msg.style.color = 'white';
    msg.style.fontWeight = '600';
    msg.style.zIndex = '2000';
    msg.style.boxShadow = 'var(--shadow)';
    msg.style.transition = 'opacity 0.3s';
    
    const colors = { 'success': '#28a745', 'danger': '#dc3545', 'info': '#17a2b8' };
    msg.style.backgroundColor = colors[type] || 'var(--primary)';
    
    document.body.appendChild(msg);
    
    setTimeout(() => {
        msg.style.opacity = '0';
        setTimeout(() => document.body.removeChild(msg), 300);
    }, 3000);
}

// ========== 初始化 ==========
document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
